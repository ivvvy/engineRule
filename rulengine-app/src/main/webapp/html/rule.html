<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>规则</title>
    <script type="text/javascript" src="../js/libs/jquery-3.2.1.js"></script>
    <script type="text/javascript" src="../js/libs/ace.js"></script>
    <script type="text/javascript" src="../js/libs/translate.js"></script>
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        body {
            padding: 20px;
        }

        input {
            height: 20px;
        }

        select {
            height: 24px;
        }

        .level {
            position: relative;
            min-height: 30px;
            line-height: 30px;
        }

        .level > .level {
            left: 85px;
        }

        [class*="level_"] {
            display: inline-block;
            top: 0;
            left: 85px;
        }

        .icons {
            font-size: 12px;
            color: red;
        }

        .icons > span {
            display: none;
            cursor: pointer;
            text-decoration: underline;
        }

        .ruleContainer .level_1:first-child .icon-add {
            display: inline;
        }

        .level_1 .icons > span.icon-child,
        .level_2 .icons > span.icon-child {
            display: inline;
        }

        [data-group] {
            display: none;
        }

        .icons > span.icon-remove,
        .icons > span.icon-add-then,
        .icons > span.icon-remove-then {
            display: inline;
        }

        .then {
            margin-left: 85px;
            height: 30px;
            line-height: 30px;
        }
    </style>
</head>
<body>
名称：<input type="text" name="ruleName"/>
<hr style="margin: 10px 0;">

<div class="ruleContainer">
    <span style="line-height: 30px; position: absolute;width:80px;text-align: center;">IF</span>

    <div class="level">
        <div class="level_1" style="margin-left: 85px;">
            <select name="left">
                <option value="">请选择变量</option>
                <option value="STAN_STATUS_8002" data-type="INPUT">STAN_STATUS_8002</option>
                <option value="STAN_STATUS_8003" data-type="INPUT">STAN_STATUS_8003</option>
            </select>
            <select name="operator">
                <option value="">选择关系</option>
                <option value=">=">>=</option>
                <option value=">">></option>
                <option value="<="><=</option>
                <option value="<"><</option>
                <option value="==">==</option>
                <option value="== null">== null</option>
                <option value="!= null">!= null</option>
                <option value="!=">!=</option>
            </select>
            <span name="right">
            <select name="right" data-role="right">
                <option value="const">常量</option>
                <option value="var">变量</option>
                <option value="fn">函数</option>
            </select>
            <span name="const" data-group="right">
                <input type="text" placeholder="常量值"/>
            </span>
            <span name="var" data-group="right">
                <select>
                    <option>请选择变量</option>
                    <option value="STAN_CELL_PHONE_STATE" data-type="INPUT">STAN_CELL_PHONE_STATE</option>
                </select>
            </span>
            <span name="fn" data-group="right">
            <select name="ruleFN" data-role="fn">
                <option>请选择函数</option>
                <option value="krange" data-paramsCount="3">krange</option>
                <option value="groupAppVarMax" data-paramsCount="1">groupAppVarMax</option>
            </select>
            <span>
                <span>(</span>
                <span name="parameters" data-role="parameters" data-parent="ruleFN"></span>
                <span>)</span>
            </span>
        </span>
        </span>
            <span class="icons">
                <span class="icon-add">添加</span>
                <span class="icon-child">嵌套</span>
            </span>
        </div>
    </div>
</div>
<hr style="margin: 10px 0;">
<div class="thenContainer">
    <span style="line-height: 30px; position: absolute;width:80px;text-align: center;">THEN</span>

    <div class="then">
        <select name="left">
            <option value="">请选择变量</option>
            <option value="STAN_STATUS_8002" data-type="INPUT">STAN_STATUS_8002</option>
            <option value="STAN_STATUS_8003" data-type="INPUT">STAN_STATUS_8003</option>
        </select>
        <select name="operator">
            <option value="=">=</option>
            <option value="+=">+=</option>
            <option value="-=">-=</option>
        </select>
        <span name="right">
            <select name="thenRight" data-role="right">
                <option value="const">常量</option>
                <option value="var">变量</option>
                <option value="fn">函数</option>
            </select>
            <span name="const" data-group="thenRight">
                <input type="text" placeholder="常量值"/>
            </span>
            <span name="var" data-group="thenRight">
                <select>
                    <option>请选择变量</option>
                    <option value="STAN_CELL_PHONE_STATE" data-type="INPUT">STAN_CELL_PHONE_STATE</option>
                </select>
            </span>
            <span name="fn" data-group="thenRight">
                <select name="thenFN" data-role="fn">
                    <option>请选择函数</option>
                    <option value="krange" data-paramsCount="3">krange</option>
                    <option value="groupAppVarMax" data-paramsCount="1">groupAppVarMax</option>
                </select>
                <span>
                    <span>(</span>
                    <span name="parameters" data-role="parameters" data-parent="thenFN"></span>
                    <span>)</span>
                </span>
            </span>
        </span>
        <span class="icons">
            <span class="icon-add-then">添加</span>
        </span>
    </div>
</div>
<div class="sourceContainer">

</div>

<div class="template" style="display:none;">
    <div class="level">
        <select name="type">
            <option value="&&">&&(并且)</option>
            <option value="||">||(或者)</option>
        </select>

        <div class="level_N">
            <select name="left">
                <option value="">请选择变量</option>
                <option value="STAN_STATUS_8002" data-type="INPUT">STAN_STATUS_8002</option>
                <option value="STAN_STATUS_8003" data-type="INPUT">STAN_STATUS_8003</option>
            </select>
            <select name="operator">
                <option value="">选择关系</option>
                <option value=">=">>=</option>
                <option value=">">></option>
                <option value="<="><=</option>
                <option value="<"><</option>
                <option value="==">==</option>
                <option value="== null">== null</option>
                <option value="!= null">!= null</option>
                <option value="!=">!=</option>
            </select>
            <span name="right">
                    <select name="right" data-role="right">
                        <option value="const">常量</option>
                        <option value="var">变量</option>
                        <option value="fn">函数</option>
                    </select>
                    <span name="const" data-group="right">
                        <input type="text" placeholder="常量值"/>
                    </span>
                    <span name="var" data-group="right">
                        <select>
                            <option>请选择变量</option>
                            <option value="STAN_CELL_PHONE_STATE" data-type="INPUT">STAN_CELL_PHONE_STATE</option>
                        </select>
                    </span>
                    <span name="fn" data-group="right">
                <select name="ruleFN" data-role="fn">
                    <option>请选择函数</option>
                    <option value="krange" data-paramsCount="3">krange</option>
                    <option value="groupAppVarMax" data-paramsCount="1">groupAppVarMax</option>
                </select>
                <span>
                    <span>(</span>
                    <span name="parameters" data-role="parameters" data-parent="ruleFN"></span>
                    <span>)</span>
                </span>
            </span>
                </span>
            <span class="icons">
                <span class="icon-add">添加</span>
                <span class="icon-remove">删除</span>
                <span class="icon-child">嵌套</span>
            </span>
        </div>
    </div>
</div>
<div class="template_then" style="display: none;">
    <div class="then">
        <select name="left">
            <option value="">请选择变量</option>
            <option value="STAN_STATUS_8002" data-type="INPUT">STAN_STATUS_8002</option>
            <option value="STAN_STATUS_8003" data-type="INPUT">STAN_STATUS_8003</option>
        </select>
        <select name="operator">
            <option value="=">=</option>
            <option value="+=">+=</option>
            <option value="-=">-=</option>
        </select>
        <span name="right">
            <select name="thenRight" data-role="right">
                <option value="const">常量</option>
                <option value="var">变量</option>
                <option value="fn">函数</option>
            </select>
            <span name="const" data-group="thenRight">
                <input type="text" placeholder="常量值"/>
            </span>
            <span name="var" data-group="thenRight">
                <select>
                    <option>请选择变量</option>
                    <option value="STAN_CELL_PHONE_STATE" data-type="INPUT">STAN_CELL_PHONE_STATE</option>
                </select>
            </span>
            <span name="fn" data-group="thenRight">
                <select name="thenFN" data-role="fn">
                    <option>请选择函数</option>
                    <option value="krange" data-paramsCount="3">krange</option>
                    <option value="groupAppVarMax" data-paramsCount="1">groupAppVarMax</option>
                </select>
                <span>
                    <span>(</span>
                    <span name="parameters" data-role="parameters" data-parent="thenFN"></span>
                    <span>)</span>
                </span>
            </span>
        </span>
        <span class="icons">
            <span class="icon-add-then">添加</span>
            <span class="icon-remove-then">删除</span>
        </span>
    </div>
</div>
<script type="text/javascript">
    $(function () {
        //控制right部分切换
        var switchRight = function (_self, outer) {
            var rightType = $(_self).val(), group = $(_self).attr("name");
            outer.find('[data-group="' + group + '"]').hide();
            outer.find('[data-group="' + group + '"][name="' + rightType + '"]').show();
        };
        $('select[data-role="right"]').each(function () {
            switchRight(this, $(this).parent());
        });
        $('.ruleContainer,.thenContainer').on('change', 'select[data-role="right"]', function () {
            switchRight(this, $(this).parent());
        });

        //控制函数显示
        var switchFN = function (_self, outer) {
            var paramTpl = function (index) {
                return '<select name="fnRight_' + index + '" data-role="right"><option value="const">常量</option><option value="var">变量</option></select><span name="const" data-group="fnRight_' + index + '"><input type="text" placeholder="常量值" style="width:100px;margin:0 3px;"/></span><span name="var" data-group="fnRight_' + index + '"><select style="margin: 0 3px;"><option>请选择变量</option><option value="STAN_CELL_PHONE_STATE" data-type="INPUT">STAN_CELL_PHONE_STATE</option></select></span>';
            }
            var group = $(_self).attr("name"), paramCount = $(_self).find("option:selected").attr('data-paramsCount') || 0;
            var paramContainer = outer.find('[data-role="parameters"][data-parent="' + group + '"]');
            var params = [];
            for (var i = 0; i < paramCount * 1; i++)params.push(paramTpl(i));
            paramContainer.html(params.join('<span style="padding: 0 5px;">,</span>'));

            $('select[data-role="right"]').each(function () {
                switchRight(this, $(this).parent());
            });
        };
        $('select[data-role="fn"]').each(function () {
            $(this).on('change', function () {
                switchFN(this, $(this).parent());
            });
        });

        //添加条件节点
        //控制条件的操作按钮
        var controlOperator = function () {
            var firstLevels = $(".ruleContainer > .level");
            firstLevels.each(function () {
                $(this).find(".level_2").first().find(".icon-add").show();
            });
            var secodeLevels = $(".ruleContainer > .level > .level");
            secodeLevels.each(function () {
                $(this).find(".level_3").first().find(".icon-add").show();
            });
        };
        //平级条件
        $('.ruleContainer').on('click', '.icon-add', function () {
            var levelItem = $(this).parents(".level").first(), conditionContainer = levelItem.parent();
            var level = levelItem.find('[class*="level_"]').attr("class").match(/level_(\d+)/)[1] * 1;
            conditionContainer.append($('.template').html().replace("_N", "_" + level));
            controlOperator();
        });

        //嵌套条件
        $('.ruleContainer').on('click', '.icon-child', function () {
            var levelItem = $(this).parents(".level").first();
            var level = levelItem.find('[class*="level_"]').attr("class").match(/level_(\d+)/)[1] * 1;
            levelItem.append($('.template').html().replace("_N", "_" + (level + 1)));
            controlOperator();
        });

        //删除条件
        $('.ruleContainer').on('click', '.icon-remove', function () {
            $(this).parents('.level').first().remove();
        });

        //添加结果
        $('.thenContainer').on('click', '.icon-add-then', function () {
            var thenContainer = $('.thenContainer');
            thenContainer.append($('.template_then').html());

            $('select[data-role="fn"]').each(function () {
                $(this).on('change', function () {
                    switchFN(this, $(this).parent());
                });
            });
        });

        //删除结果
        $(".thenContainer").on('click', '.icon-remove-then', function () {
            $(this).parents(".then").remove();
        });

        //获取规则的json数据
        var getRuleData = function () {
        };
    });
</script>
</body>
</html>